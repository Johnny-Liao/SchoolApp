Ext.define("Ext.ux.BoxReorderer",{mixins:{observable:"Ext.util.Observable"},itemSelector:".x-box-item",animate:100,constructor:function(){this.addEvents("StartDrag","Drag","ChangeIndex","Drop");this.mixins.observable.constructor.apply(this,arguments)},init:function(a){this.container=a;this.container.afterLayout=Ext.Function.createSequence(this.container.afterLayout,this.afterFirstLayout,this);a.destroy=Ext.Function.createSequence(a.destroy,this.onContainerDestroy,this)},onContainerDestroy:function(){if(this.dd){this.dd.unreg()}},afterFirstLayout:function(){var b=this,a=b.container.getLayout();delete b.container.afterLayout;b.dd=Ext.create("Ext.dd.DD",a.innerCt,b.container.id+"-reorderer");Ext.apply(b.dd,{animate:b.animate,reorderer:b,container:b.container,getDragCmp:this.getDragCmp,clickValidator:Ext.Function.createInterceptor(b.dd.clickValidator,b.clickValidator,b,false),onMouseDown:b.onMouseDown,startDrag:b.startDrag,onDrag:b.onDrag,endDrag:b.endDrag,getNewIndex:b.getNewIndex,doSwap:b.doSwap,findReorderable:b.findReorderable});b.dd.dim=a.parallelPrefix;b.dd.startAttr=a.parallelBefore;b.dd.endAttr=a.parallelAfter},getDragCmp:function(a){return this.container.getChildByElement(a.getTarget(this.itemSelector,10))},clickValidator:function(b){var a=this.getDragCmp(b);return !!(a&&a.reorderable!==false)},onMouseDown:function(g){var f=this,a=f.container,d,b,c;f.dragCmp=f.getDragCmp(g);if(f.dragCmp){b=f.dragCmp.getEl();f.startIndex=f.curIndex=a.items.indexOf(f.dragCmp);c=b.getPageBox();f.lastPos=c[this.startAttr];d=a.el.getPageBox();if(f.dim==="width"){f.minX=d.left;f.maxX=d.right-c.width;f.minY=f.maxY=c.top;f.deltaX=g.getPageX()-c.left}else{f.minY=d.top;f.maxY=d.bottom-c.height;f.minX=f.maxX=c.left;f.deltaY=g.getPageY()-c.top}f.constrainY=f.constrainX=true}},startDrag:function(){var a=this;if(a.dragCmp){a.dragCmp.setPosition=Ext.emptyFn;if(!a.container.layout.animate&&a.animate){a.container.layout.animate=a.animate;a.removeAnimate=true}a.dragElId=a.dragCmp.getEl().id;a.reorderer.fireEvent("StartDrag",a,a.container,a.dragCmp,a.curIndex);a.dragCmp.suspendEvents();a.dragCmp.disabled=true;a.dragCmp.el.setStyle("zIndex",100)}else{a.dragElId=null}},findReorderable:function(c){var d=this,a=d.container.items,b;if(a.getAt(c).reorderable===false){b=a.getAt(c);if(c>d.startIndex){while(b&&b.reorderable===false){c++;b=a.getAt(c)}}else{while(b&&b.reorderable===false){c--;b=a.getAt(c)}}}c=Math.min(Math.max(c,0),a.getCount()-1);if(a.getAt(c).reorderable===false){return -1}return c},doSwap:function(c){var d=this,a=d.container.items,f,b,e;c=d.findReorderable(c);if(c===-1){return}d.reorderer.fireEvent("ChangeIndex",d,d.container,d.dragCmp,d.startIndex,c);f=a.getAt(d.curIndex);b=a.getAt(c);a.remove(f);e=Math.min(Math.max(c,0),a.getCount()-1);a.insert(e,f);a.remove(b);a.insert(d.curIndex,b);d.container.layout.layout();d.curIndex=c},onDrag:function(c){var b=this,a;a=b.getNewIndex(c.getPoint());if((a!==undefined)){b.reorderer.fireEvent("Drag",b,b.container,b.dragCmp,b.startIndex,b.curIndex);b.doSwap(a)}},endDrag:function(b){b.stopEvent();var a=this;if(a.dragCmp){delete a.dragElId;if(a.animate){a.container.layout.animate={callback:Ext.Function.bind(a.reorderer.afterBoxReflow,a)}}delete a.dragCmp.setPosition;a.container.layout.layout();if(a.removeAnimate){delete a.removeAnimate;delete a.container.layout.animate}else{a.reorderer.afterBoxReflow.call(a)}a.reorderer.fireEvent("drop",a,a.container,a.dragCmp,a.startIndex,a.curIndex)}},afterBoxReflow:function(){var a=this;a.dragCmp.el.setStyle("zIndex","");a.dragCmp.disabled=false;a.dragCmp.resumeEvents()},getNewIndex:function(h){var g=this,a=g.getDragEl(),b=Ext.fly(a).getPageBox(),l,f,k,d=0,c=g.container.items.items,e=c.length,j=g.lastPos;g.lastPos=b[g.startAttr];for(;d<e;d++){l=c[d].getEl();if(l.is(g.reorderer.itemSelector)){f=l.getPageBox();k=f[g.startAttr]+(f[g.dim]>>1);if(d<g.curIndex){if((b[g.startAttr]<j)&&(b[g.startAttr]<(k-5))){return d}}else{if(d>g.curIndex){if((b[g.startAttr]>j)&&(b[g.endAttr]>(k+5))){return d}}}}}}});