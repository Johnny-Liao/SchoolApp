Ext.define("Ext.ux.DataView.Animated",{defaults:{duration:750,idProperty:"id"},constructor:function(a){Ext.apply(this,a||{},this.defaults)},init:function(a){this.dataview=a;var c=this.idProperty,b=a.store;a.blockRefresh=true;a.updateIndexes=Ext.Function.createSequence(a.updateIndexes,function(){this.getTargetEl().select(this.itemSelector).each(function(f,g,e){f.id=f.dom.id=Ext.util.Format.format("{0}-{1}",a.id,b.getAt(e).internalId)},this)},a);this.dataviewID=a.id;this.cachedStoreData={};this.cacheStoreData(b.data||b.snapshot);a.on("resize",function(){var e=a.store;if(e.getCount()>0){}},this);a.store.on("datachanged",d,this);function d(n){var l=a.getTargetEl(),h=n.getAt(0),p=this.getAdded(n),x=this.getRemoved(n),i=this.getRemaining(n),u=Ext.apply({},i,p);Ext.each(x,function(C){var D=this.dataviewID+"-"+C.internalId;Ext.fly(D).animate({remove:false,duration:e,opacity:0,useDisplay:true,callback:function(){Ext.fly(D).setDisplayed(false)}})},this);if(h==undefined){this.cacheStoreData(n);return}this.cacheStoreData(n);var g=Ext.get(this.dataviewID+"-"+h.internalId);if(!g){a.refresh();return true}var z=n.getCount(),k=g.getMargin("lr")+g.getWidth(),v=g.getMargin("bt")+g.getHeight(),r=l.getWidth(),f=Math.floor(r/k),q=Math.ceil(z/f),A=Math.ceil(this.getExistingCount()/f);var j={},B={},s={};Ext.iterate(i,function(E,D){var E=D.internalId,C=s[E]=Ext.get(this.dataviewID+"-"+E);j[E]={top:C.getTop()-l.getTop()-C.getMargin("t")-l.getPadding("t"),left:C.getLeft()-l.getLeft()-C.getMargin("l")-l.getPadding("l")}},this);l.applyStyles({display:"block",position:"relative"});Ext.iterate(i,function(F,E){var C=j[F],D=s[F];if(D.getStyle("position")!="absolute"){s[F].applyStyles({position:"absolute",left:C.left+"px",top:C.top+"px"})}});var o=0;Ext.iterate(n.data.items,function(E){var I=E.internalId,D=s[I];var C=o%f,H=Math.floor(o/f),G=H*v,F=C*k;B[I]={top:G,left:F};o++},this);var t=new Date(),e=this.duration,m=this.dataviewID;var y=function(){var L=new Date()-t,N=L/e,C;if(N>=1){for(C in B){Ext.fly(m+"-"+C).applyStyles({top:B[C].top+"px",left:B[C].left+"px"})}Ext.TaskManager.stop(w)}else{for(C in B){if(!i[C]){continue}var F=j[C],I=B[C],G=F.top,J=I.top,E=F.left,K=I.left,H=N*Math.abs(G-J),M=N*Math.abs(E-K),O=G>J?G-H:G+H,D=E>K?E-M:E+M;Ext.fly(m+"-"+C).applyStyles({top:O+"px",left:D+"px"}).setDisplayed(true)}}};var w={run:y,interval:20,scope:this};Ext.TaskManager.start(w);Ext.iterate(p,function(D,C){Ext.fly(this.dataviewID+"-"+C.internalId).applyStyles({top:B[C.internalId].top+"px",left:B[C.internalId].left+"px"}).setDisplayed(true);Ext.fly(this.dataviewID+"-"+C.internalId).animate({remove:false,duration:e,opacity:1})},this);this.cacheStoreData(n)}},cacheStoreData:function(a){this.cachedStoreData={};a.each(function(b){this.cachedStoreData[b.internalId]=b},this)},getExisting:function(){return this.cachedStoreData},getExistingCount:function(){var c=0,b=this.getExisting();for(var a in b){c++}return c},getAdded:function(a){var b={};a.each(function(c){if(this.cachedStoreData[c.internalId]==undefined){b[c.internalId]=c}},this);return b},getRemoved:function(a){var b=[],c;for(c in this.cachedStoreData){if(a.findBy(function(d){return d.internalId==c})==-1){b.push(this.cachedStoreData[c])}}return b},getRemaining:function(a){var b={};a.each(function(c){if(this.cachedStoreData[c.internalId]!=undefined){b[c.internalId]=c}},this);return b}});